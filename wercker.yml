# This references the default golang container from
# the Docker Hub: https://registry.hub.docker.com/u/library/golang/
# If you want Google's container you would reference google/golang
# Read more about containers on our dev center
# http://devcenter.wercker.com/docs/containers/index.html
box: golang:1.13.5
# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# http://devcenter.wercker.com/docs/pipelines/index.html
build:
# The steps that will be executed on build
# Steps make up the actions in your pipeline
# Read more about steps on our dev center:
# http://devcenter.wercker.com/docs/steps/index.html
  steps:
    # Sets the go workspace and places you package
    # at the right place in the workspace tree
    - wercker/setup-go-workspace:
      package-dir: github.com/getlantern/flashlight
    - add-ssh-key:
      keyname: flashlight_key
      host: github.com
    # For https://github.com/wercker/step-add-to-known_hosts/issues/13
    - add-to-known_hosts@2.0.1:
      hostname: github.com
      fingerprint: D7:9F:07:61:10:B3:92:93:E3:49:AC:89:84:5B:03:80:C1:9E:2F:8B
      type: rsa
    - script:
      name: authenticate git
      code: git config --global url."https://71cee071ea22b7ffb10f68fa330d1130133bbfbd:x-oauth-basic@github.com/".insteadOf "https://github.com/"
    - install-packages:
      packages: lsof libpcap-dev libappindicator3-dev libwebkit2gtk-4.0-dev # lsof required by fdcount
    - script:
      name: make-lantern
      code: |
        HEADLESS=true make lantern
    - script:
      name: get goveralls
      code: |-
        go get golang.org/x/tools/cmd/cover
        go get -v github.com/mattn/goveralls
    - script:
      name: adjust race detector
      code: export GORACE=history_size=7
    - script:
        name: build all tests
        code: go test -run @ ./...
    - script:
      name: test-and-cover
      code: make test-and-cover
    - tcnksm/goveralls:
      token: $COVERALLS_TOKEN
